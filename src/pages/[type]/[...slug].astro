---
import { getCollection } from "astro:content";
import Layout from "../../layouts/Layout.astro";
import Header from "../../components/Header.astro";
import Footer from "../../components/Footer.astro";
import FormattedDate from "../../components/FormattedDate.astro";

export async function getStaticPaths() {
  const posts = await getCollection("texts");

  return posts.map((post: any) => ({
    params: { type: post.data.type, slug: post.slug },
    props: { post },
  }));
}

const { post } = Astro.props as { post?: any };

if (!post?.data) {
  return new Response("Not found", { status: 404 });
}

const { title, type, heroImage, pubDate, color } = post.data;
const { Content } = await post.render();

const mapTypeTitle = (t = "") => {
  if (t === "lagrimas") return "Lágrimas de Siddartha";
  if (t === "colores") return "En las luces de colores";
  if (t === "still") return "Still Prefer Sentir";
  if (t === "placebo") return "Placebo Onírico";
  if (t === "pintas") return "Pintas Heredadas";
  return t;
};

const typeTitle = mapTypeTitle(type);
---

<Layout title={title} bg={color}>
    <Header />
    <main class="flex flex-col lg:flex-row w-full min-h-screen" style={`background-color: ${color}`}>
        <div class="relative w-full aspect-[2/3] lg:w-[40vw] lg:h-screen lg:sticky lg:top-0 lg:aspect-auto lg:overflow-hidden shrink-0">
            <img src={heroImage} alt="" class="w-full h-full object-cover" loading="eager" decoding="async"/>
            <div class="pointer-events-none absolute inset-x-0 bottom-0 h-20 lg:hidden" style={`background: linear-gradient(to bottom, rgba(0,0,0,0), ${color});`}></div>
            <div class="pointer-events-none absolute inset-x-0 top-0 h-20 lg:hidden" style={`background: linear-gradient(to top, rgba(0,0,0,0), ${color});`}></div>
            <div class="hidden lg:block pointer-events-none absolute inset-y-0 right-0 w-24" style={`background: linear-gradient(to right, rgba(0,0,0,0), ${color});`}></div>
        </div>

        <section class="flex flex-col w-full lg:flex-1 text-white">
            <div class="w-full max-w-[1100px] mx-auto px-6 lg:px-10 mt-12 lg:mt-10 flex flex-col h-full">
                <header class="pb-2 border-b-2 border-white/50">
                    <h3 class="text-xl capitalize">{typeTitle}</h3>
                    <h1 class="text-4xl font-bebas font-bold">{title}</h1>
                    <FormattedDate date={pubDate} format="long" />
                </header>
                <article lang="es" class="py-12 font-besley text-base leading-relaxed text-justify hyphens-auto">
                    <Content />
                </article>
                <div class="mt-auto">
                    <Footer theme="text" />
                </div>
            </div>
        </section>
    </main>

    <button type="button" aria-label="Volver arriba" class="fixed bottom-5 right-5 z-50 rounded-full px-4 py-3 text-white bg-black/30 backdrop-blur-sm border border-white/20 shadow-lg hover:bg-black/40 transition opacity-0 pointer-events-none" onclick="window.scrollTo({ top: 0, behavior: 'smooth' })">
        <i class="ti ti-chevron-up"></i>
    </button>

    <script is:inline>
        (() => {
        const btn = document.querySelector('[aria-label="Volver arriba"]');
        if (!btn) return;

        const toggle = () => {
            const show = window.scrollY >= 300;
            btn.classList.toggle("opacity-0", !show);
            btn.classList.toggle("pointer-events-none", !show);
        };

        window.addEventListener("scroll", toggle, { passive: true });
        toggle();
        })();
    </script>
</Layout>
