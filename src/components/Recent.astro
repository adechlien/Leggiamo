---
import FormattedDate from "./FormattedDate.astro";

import { getCollection } from "astro:content";

const posts = await getCollection("texts");

// Ordenar por fecha de publicación (descendente, más reciente primero)
const sortedPosts = posts.sort((a: any, b: any) => {
  return (
    new Date(b.data.pubDate).getTime() - new Date(a.data.pubDate).getTime()
  );
});

// Tomar los 3 más recientes (o menos si no hay suficientes)
const recentPosts = sortedPosts.slice(0, 4);

// helper para mapear el tipo a texto legible
const mapType = (type = "") => {
  if (type === "lagrimas") return "Lágrimas de Siddartha"; // Meditaciones
  if (type === "colores") return "En las luces de colores"; // Cuentos
  if (type === "still") return "Still Prefer Sentir"; // Poemas
  if (type === "placebo") return "Placebo Onírico";
  return type;
};
---

<main class="flex flex-col gap-4 sm:w-[500px] sm:mx-auto">
  <h2 class="text-6xl font-bold text-left font-staatliches">Recientes</h2>
  <ul class="flex flex-col gap-6">
    {
      recentPosts.length > 0 ? (
        recentPosts.map((post: any) => {
          const previewContent = (post.body ?? "").replace("<br>", " ").replace(/<\/?[^>]+>/g, "").replace(/\s+/g, " ").trim();
          const typeUrl = mapType(post.data.type);
          return (
            <li>
              <article>
                  <a href={`/${post.data.type}/${post.slug}`} class="block">
                    <div class="relative isolate overflow-hidden rounded-xl aspect-[16/9] border border-white/10">
                      <img
                        src={post.data.heroSmImage}
                        alt={post.data.title}
                        class="absolute inset-0 h-full w-full object-cover pointer-events-none select-none"
                        loading="lazy"
                      />

                      {/* Panel blur: posicionado, no h-full en flujo */}
                      <div
                        class="absolute inset-3 rounded-xl border border-white/20 bg-black/25
                               backdrop-blur-md [-webkit-backdrop-filter:blur(12px)] [transform:translateZ(0)] will-change-transform"
                      >
                        <div class="flex h-full flex-col px-3 py-2 min-w-0">
                          <h2 class="text-white font-bebas text-start text-xl min-w-0">
                            {post.data.title}
                          </h2>
                          <p lang="es"
                             class="my-1 text-sm leading-snug text-white text-justify hyphens-auto
                                    [display:-webkit-box] [-webkit-line-clamp:4] [-webkit-box-orient:vertical]
                                    overflow-hidden min-w-0">
                            {previewContent}
                          </p>
                          <p class="mt-auto text-white text-base text-right">{typeUrl}</p>
                        </div>
                      </div>
                    </div>
                  </a>

              </article>
            </li>
          );
        })
      ) : (
        <li class="text-sm text-white/80">No hay textos aún.</li>
      )
    }
  </ul>
</main>
