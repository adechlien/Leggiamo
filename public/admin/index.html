<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Content Manager</title>
  </head>
  <body>
    <script src="https://identity.netlify.com/v1/netlify-identity-widget.js"></script>

    <script>
      (function () {
        const hash = window.location.hash || "";
        const tokenMatch = hash.match(/(invite_token|recovery_token)=([^&]+)/);

        // Solo tocamos cosas si realmente vienes con invite/recovery token
        if (tokenMatch) {
          const tokenType = tokenMatch[1];
          const tokenValue = tokenMatch[2];

          // Normaliza "#/invite_token=..." -> "#invite_token=..."
          window.location.hash = `#${tokenType}=${tokenValue}`;

          // Abre el modal de Identity para setear contraseña
          window.netlifyIdentity &&
            window.netlifyIdentity.on("init", () => window.netlifyIdentity.open());

          // Después de completar, limpia la URL (sin hash) una sola vez
          window.netlifyIdentity &&
            window.netlifyIdentity.on("login", () => window.location.replace("/admin/"));
        }
      })();
    </script>

    <script src="https://unpkg.com/decap-cms@^3.0.0/dist/decap-cms.js"></script>
    <script>
      // 16 bytes -> 22 chars base64url (sin "="). Ej: cJ8vQm3sT4eK2x9pN7aB1w
      function makeShortId() {
        const bytes = new Uint8Array(16);
        crypto.getRandomValues(bytes);
        let str = "";
        for (const b of bytes) str += String.fromCharCode(b);
        return btoa(str).replace(/\+/g, "-").replace(/\//g, "_").replace(/=+$/, "");
      }

      // Hook: antes de guardar, si no hay id, lo crea
      CMS.registerEventListener({
        name: "preSave",
        handler: ({ entry }) => {
          const data = entry.get("data");
          const id = data.get("id");
          if (id) return entry; // no sobreescribir

          const newId = makeShortId();
          return entry.set("data", data.set("id", newId));
        },
      });
    </script>

  </body>
</html>
